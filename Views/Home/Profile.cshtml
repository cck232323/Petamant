@{
    ViewData["Title"] = "个人资料";
}

<div class="container">
    <h1>个人资料</h1>
    
    <div class="row">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    基本信息
                </div>
                <div class="card-body">
                    <div id="profileInfo">
                        <div class="text-center">
                            <div class="spinner-border" role="status">
                                <span class="sr-only">加载中...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        @* <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    我的活动
                </div>
                <div class="card-body">
                    <ul class="nav nav-tabs" id="myTab" role="tablist">
                        <li class="nav-item">
                            <a class="nav-link active" id="created-tab" data-toggle="tab" href="#created" role="tab">我创建的</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" id="registered-tab" data-toggle="tab" href="#registered" role="tab">我报名的</a>
                        </li>
                    </ul>
                    <div class="tab-content mt-3" id="myTabContent">
                        <div class="tab-pane fade show active" id="created" role="tabpanel">
                            <div id="createdActivities">
                                <div class="text-center">
                                    <div class="spinner-border" role="status">
                                        <span class="sr-only">加载中...</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="tab-pane fade" id="registered" role="tabpanel">
                            <div id="registeredActivities">
                                <div class="text-center">
                                    <div class="spinner-border" role="status">
                                        <span class="sr-only">加载中...</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div> *@
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function() {
            // 检查是否已登录
            var token = localStorage.getItem("token");
            if (!token) {
                alert("请先登录！");
                window.location.href = "/Home/Index";
                return;
            }
            
            // 解析JWT获取用户ID
            var payload = JSON.parse(atob(token.split('.')[1]));
            console.log("JWT payload:", payload);
            
            // 尝试所有可能的用户ID字段
            var userId = parseInt(
                payload.nameid || 
                payload["http://schemas.xmlsoap.org/ws/2005/05/identity/claims/nameidentifier"] || 
                0
            );
            console.log("当前用户ID:", userId);
            
            if (userId === 0) {
                alert("无法获取用户ID，请重新登录");
                window.location.href = "/Home/Index";
                return;
            }
            
            // 加载用户资料
            $.ajax({
                url: `/api/users/${userId}`,
                type: "GET",
                headers: {
                    "Authorization": "Bearer " + token
                },
                success: function(user) {
                    var profileHtml = `
                        <h4>${user.userName}</h4>
                        <p><strong>邮箱:</strong> ${user.email}</p>
                    `;
                    $("#profileInfo").html(profileHtml);
                },
                error: function(xhr) {
                    console.error("加载用户资料失败:", xhr);
                    $("#profileInfo").html(`
                        <div class="alert alert-danger">
                            加载用户资料失败: ${xhr.status} ${xhr.statusText}
                        </div>
                    `);
                }
            });
            
            // 加载用户创建的活动
            $.ajax({
                url: `/api/activities/user/${userId}/created`,
                type: "GET",
                headers: {
                    "Authorization": "Bearer " + token
                },
                success: function(activities) {
                    if (activities.length === 0) {
                        $("#createdActivities").html("<p>您还没有创建任何活动</p>");
                        return;
                    }
                    
                    var activitiesHtml = "<div class='list-group'>";
                    activities.forEach(function(activity) {
                        activitiesHtml += `
                            <a href="#" class="list-group-item list-group-item-action" data-id="${activity.id}">
                                <div class="d-flex w-100 justify-content-between">
                                    <h5 class="mb-1">${activity.title}</h5>
                                    <small>${new Date(activity.date).toLocaleDateString()}</small>
                                </div>
                                <p class="mb-1">${activity.description.substring(0, 100)}${activity.description.length > 100 ? '...' : ''}</p>
                                <small>地点: ${activity.location} | 报名人数: ${activity.registrationsCount || 0}</small>
                            </a>
                        `;
                    });
                    activitiesHtml += "</div>";
                    
                    $("#createdActivities").html(activitiesHtml);
                },
                error: function(xhr) {
                    console.error("加载创建的活动失败:", xhr);
                    $("#createdActivities").html(`
                        <div class="alert alert-danger">
                            加载活动失败: ${xhr.status} ${xhr.statusText}
                        </div>
                    `);
                }
            });
            
            // 加载用户报名的活动
            $.ajax({
                url: `/api/activities/user/${userId}/registered`,
                type: "GET",
                headers: {
                    "Authorization": "Bearer " + token
                },
                success: function(activities) {
                    if (activities.length === 0) {
                        $("#registeredActivities").html("<p>您还没有报名任何活动</p>");
                        return;
                    }
                    
                    var activitiesHtml = "<div class='list-group'>";
                    activities.forEach(function(activity) {
                        activitiesHtml += `
                            <a href="#" class="list-group-item list-group-item-action" data-id="${activity.id}">
                                <div class="d-flex w-100 justify-content-between">
                                    <h5 class="mb-1">${activity.title}</h5>
                                    <small>${new Date(activity.date).toLocaleDateString()}</small>
                                </div>
                                <p class="mb-1">${activity.description.substring(0, 100)}${activity.description.length > 100 ? '...' : ''}</p>
                                <small>地点: ${activity.location} | 创建者: ${activity.creatorUserName || '未知'}</small>
                            </a>
                        `;
                    });
                    activitiesHtml += "</div>";
                    
                    $("#registeredActivities").html(activitiesHtml);
                },
                error: function(xhr) {
                    console.error("加载报名的活动失败:", xhr);
                    $("#registeredActivities").html(`
                        <div class="alert alert-danger">
                            加载活动失败: ${xhr.status} ${xhr.statusText}
                        </div>
                    `);
                }
            });
            
            // 绑定活动点击事件
            $(document).on("click", ".list-group-item", function() {
                var activityId = $(this).data("id");
                // 这里可以添加查看活动详情的逻辑
                console.log("点击活动ID:", activityId);
            });
        });
    </script>
}