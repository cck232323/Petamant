@model IEnumerable<MyDotnetApp.Models.Activity>

@{
    ViewData["Title"] = "活动列表";
}

<div id="auth-loading" class="text-center my-5">
    <div class="spinner-border" role="status">
        <span class="sr-only">正在验证登录状态...</span>
    </div>
    <p class="mt-2">正在验证登录状态...</p>
</div>

<div id="activities-content" style="display: none;">
    <h1>宠物活动列表</h1>
    
    <button id="createActivityBtn" class="btn btn-primary mb-3">创建新活动</button>
    
    <div id="activityList" class="row">
        <!-- 活动列表将通过JavaScript动态加载 -->
    </div>
    
    <!-- 活动详情模态框 -->
    <div class="modal fade" id="activityDetailModal" tabindex="-1" role="dialog" aria-labelledby="activityDetailModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="activityDetailModalLabel">活动详情</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body" id="activityDetailsContent">
                    <!-- 活动详情将通过AJAX加载 -->
                    <div class="text-center">
                        <div class="spinner-border" role="status">
                            <span class="sr-only">加载中...</span>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">关闭</button>
                    <button type="button" class="btn btn-success" id="modalRegisterBtn">报名参加</button>
                    <!-- 添加删除按钮，初始隐藏 -->
                    <button type="button" class="btn btn-danger" id="deleteActivityBtn" style="display: none;">删除活动</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 创建活动模态框 -->
    <div class="modal fade" id="createActivityModal" tabindex="-1" role="dialog" aria-labelledby="createActivityModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="createActivityModalLabel">创建新活动</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <form id="createActivityForm">
                        <div class="form-group">
                            <label for="activityTitle">活动标题</label>
                            <input type="text" class="form-control" id="activityTitle" required>
                        </div>
                        <div class="form-group">
                            <label for="activityDescription">活动描述</label>
                            <textarea class="form-control" id="activityDescription" rows="3" required></textarea>
                        </div>
                        <div class="form-group">
                            <label for="activityDate">活动日期</label>
                            <input type="datetime-local" class="form-control" id="activityDate" required>
                        </div>
                        <div class="form-group">
                            <label for="activityLocation">活动地点</label>
                            <input type="text" class="form-control" id="activityLocation" required>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" id="submitActivityBtn">创建</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 报名模态框 -->
    <div class="modal fade" id="registrationModal" tabindex="-1" role="dialog" aria-labelledby="registrationModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="registrationModalLabel">活动报名</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <form id="registrationForm">
                        <div class="form-group">
                            <label for="petName">宠物名称 <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="petName" placeholder="请输入您宠物的名称">
                        </div>
                        <div class="form-group">
                            <label for="petType">宠物类型 <span class="text-danger">*</span></label>
                            <select class="form-control" id="petType">
                                <option value="">请选择宠物类型</option>
                                <option value="狗">狗</option>
                                <option value="猫">猫</option>
                                <option value="兔子">兔子</option>
                                <option value="鸟类">鸟类</option>
                                <option value="其他">其他</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="petAge">宠物年龄</label>
                            <input type="number" class="form-control" id="petAge" placeholder="请输入宠物年龄">
                        </div>
                        <div class="form-group">
                            <label for="petDescription">宠物描述 <span class="text-danger">*</span></label>
                            <textarea class="form-control" id="petDescription" rows="3" placeholder="请描述您的宠物（性格、习惯等）"></textarea>
                        </div>
                        <div class="form-group">
                            <div class="custom-control custom-checkbox">
                                <input type="checkbox" class="custom-control-input" id="agreeTerms">
                                <label class="custom-control-label" for="agreeTerms">我同意活动规则和条款 <span class="text-danger">*</span></label>
                            </div>
                        </div>
                    </form>
                    <div class="alert alert-danger" id="registrationFormError" style="display: none;"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" id="submitRegistrationBtn">提交报名</button>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="login-required" class="text-center my-5" style="display:none;">
    <div class="alert alert-warning">
        <h4>需要登录</h4>
        <p>您需要登录才能查看此页面的内容。</p>
        <a href="/Users/Login" class="btn btn-primary">去登录</a>
        <a href="/Home/Index" class="btn btn-secondary">返回首页</a>
    </div>
</div>

@section Scripts {
    <!-- 首先加载基础工具类 -->
    <script src="/js/auth.js"></script>  <!-- 修改这里，确保路径正确 -->
    @* <script src="/js/activities/api.js"></script> *@
    
    <!-- 然后加载功能组件 -->
    <script src="/js/activities/activity-list.js"></script>
    <script src="/js/activities/activity-form.js"></script>
    <script src="/js/activities/activity-detail.js"></script>
    <script src="/js/activities/registration.js"></script>
    
    <!-- 最后加载主控制器 -->
    <script src="/js/activities/main.js"></script>
    <script>
        $(document).ready(function() {
            // 确保Auth对象初始化
            if (typeof Auth !== 'undefined' && typeof Auth.init === 'function') {
                Auth.init();
            } else {
                console.error("Auth对象未定义或初始化方法不存在");
            }
            
            // 初始化其他模块
            if (typeof ActivityDetail !== 'undefined' && typeof ActivityDetail.init === 'function') {
                ActivityDetail.init();
            }
            
            if (typeof Registration !== 'undefined' && typeof Registration.init === 'function') {
                Registration.init();
            }
            
            if (typeof ActivityList !== 'undefined' && typeof ActivityList.init === 'function') {
                ActivityList.init();
            }
        });
    </script>
}