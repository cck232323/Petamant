@model MyDotnetApp.DTOs.UserLoginDto

@{
    ViewData["Title"] = "用户登录";
}

<div class="container">
    <h2>用户登录</h2>
    <div class="row">
        <div class="col-md-6">
            <form id="loginForm">
                <div class="text-danger validation-summary" style="display:none;"></div>
                
                <div class="form-group">
                    <label for="Email">邮箱</label>
                    <input id="Email" name="Email" class="form-control" />
                    <span class="text-danger email-validation"></span>
                </div>
                
                <div class="form-group">
                    <label for="Password">密码</label>
                    <input id="Password" name="Password" class="form-control" type="password" />
                    <span class="text-danger password-validation"></span>
                </div>
                
                <div class="form-group mt-3">
                    <button type="submit" class="btn btn-primary">登录</button>
                </div>
                
                <div class="mt-3">
                    没有账号？<a href="/Users/Register">点击注册</a>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function() {
            $("#loginForm").submit(function(e) {
                e.preventDefault();
                
                // 清除之前的验证消息
                $(".validation-summary").hide().empty();
                $(".email-validation").text("");
                $(".password-validation").text("");
                
                // 获取表单数据
                var loginData = {
                    Email: $("#Email").val(),
                    Password: $("#Password").val()
                };
                
                // 发送AJAX请求
                $.ajax({
                    url: "/api/users/login",
                    type: "POST",
                    contentType: "application/json",
                    data: JSON.stringify(loginData),
                    success: function(response) {
                        console.log("登录成功:", response);
                        
                        // 保存令牌到localStorage
                        localStorage.setItem("token", response.token);
                        
                        // 显示成功消息
                        alert("登录成功！");
                        
                        // 重定向到首页或其他页面
                        window.location.href = "/Home/Index";
                    },
                    error: function(xhr) {
                        console.error("登录失败:", xhr);
                        
                        if (xhr.status === 400) {
                            // 处理验证错误
                            var errors = xhr.responseJSON;
                            if (errors) {
                                if (errors.Email) {
                                    $(".email-validation").text(errors.Email[0]);
                                }
                                if (errors.Password) {
                                    $(".password-validation").text(errors.Password[0]);
                                }
                            }
                        } else if (xhr.status === 401) {
                            // 处理认证错误
                            var errorMsg = "邮箱或密码错误";
                            if (xhr.responseJSON && xhr.responseJSON.message) {
                                errorMsg = xhr.responseJSON.message;
                            }
                            $(".validation-summary").show().text(errorMsg);
                        } else {
                            // 处理其他错误
                            $(".validation-summary").show().text("登录时发生错误，请稍后再试");
                        }
                    }
                });
            });
        });
    </script>
}